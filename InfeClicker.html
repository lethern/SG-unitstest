<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfeClicker</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        .container { margin-top: 30px; }
        .button { padding: 10px; margin: 10px; font-size: 16px; cursor: pointer; }

        .unitRow{
            padding: 5px 0;
            font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
        }
        .unitLabel{
            margin-right: 20px;
			user-select: none;
        }
        .unitInfo{
            margin-left: 20px;
            border-radius: 5px;
            background-color: #badee1;
            padding: 2px 4px;
			user-select: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>InfeClicker</h1>
        <div id="units"></div>
    </div>

    <script>
        let gUnitsDiv = document.getElementById("units");

		class Resources{
			constructor(){
				this.storage = { "animus": 0 };
				this.mapping = {};
			}

			register(name, unit){
				this.mapping[name] = unit;
            }
			add(resource, mult){
				for(let name in resource){
					let amount = resource[name] * mult;
					if(!this.storage[name]) this.storage[name] = 0;
					this.storage[name] += amount;

					let mappedUnit = this.mapping[name];
					if(mappedUnit && mappedUnit.amount != this.storage[name] ){
						mappedUnit.updateAmount(this.storage[name]);
					}
				}
            }
			canAfford(resource){
				let result = true;
				for(let name in resource){
					let amount = resource[name];
					if((this.storage[name] || 0) < amount) result = false;
				}
                return result;
			}
			sub(resource){
				for(let name in resource){
					let amount = resource[name];
					this.storage[name] -= amount;

					let mappedUnit = this.mapping[name];
					if(mappedUnit && mappedUnit.amount != this.storage[name] ){
						mappedUnit.updateAmount(this.storage[name]);
					}
				}
			}
        }

		let gResources = new Resources();

		function printResource(resource, mult = 1){
			if(!resource) return '';
			let string = '';
			for(let name in resource){
				let amount = resource[name] * mult;
				if(string) string += ", ";
				let amountStr = amount.toFixed(0);
				if(amount < 1 && amount > 0) amountStr = amount.toFixed(1);
				string += `${amountStr} ${name}`;
			}
			return string;
        }

		function gUpdate(){
			units.forEach(unit => unit.updateUI());
        }

		function gProduce(){
			units.forEach(unit => unit.produce());
		}

        class Unit{
			constructor(config, enabled){
				this.userName = config.userName;
				this.resourceName = config.resourceName;
				this.config = config;
				this.enabled = enabled;
				this.amount = 0;

                this.div = addDiv(gUnitsDiv, 'unitRow');
				this.label = addSpan(this.div, 'unitLabel')
                if(this.config.addPerClick)
				    this.btn = addBtn(this.div, ()=>this.onClick());

				this.infoPerSecond = addSpan(this.div, 'unitInfo')
				this.infoPerSecond.style.display = "none";

				gResources.register(this.resourceName, this);
				if(!enabled){
					this.div.style.display = "none";
                }
			}

			enable(){
				this.div.style.display = "block";
				this.enabled = true;
            }

			updateAmount(amount){
				this.amount = amount;
				if(this.amount > 0 && !this.enabled){
					this.enable();
				}
            }
			onClick() {
				if(gResources.canAfford(this.config.clickCost)){
					gResources.sub(this.config.clickCost)
					gResources.add(this.config.addPerClick, 1)
					gUpdate();
				}

			}
			canEnable(){
				let result = true;
				if(this.config.clickCost && !gResources.canAfford(this.config.clickCost)) result = false;
				if(this.config.unlockCondition && this.config.unlockCondition.resources && !gResources.canAfford(this.config.unlockCondition.resources)) result = false;
				return result;
            }

			updateUI(){
				if(!this.enabled){
					if(this.canEnable()) this.enable();
					else return;
                }

				this.label.textContent = `${this.userName}: ${this.amount.toFixed(0)}`;
				let btnText = this.config.btnLabel || "Buy "+this.userName;
				let cost = printResource(this.config.clickCost) || '';

				if(this.btn){
					let string = btnText;
					if(cost) string += ` (${cost})`;
					this.btn.innerText = string;
                }
				if(this.config.addPerSecond && this.amount > 0){
					this.infoPerSecond.innerText = ` + ${printResource(this.config.addPerSecond, this.amount)}`;
					this.infoPerSecond.style.display = "inline-block";
                }
            }
			produce(){
				if(!this.config.addPerSecond || !this.amount) return;
				gResources.add(this.config.addPerSecond, this.amount)
            }
		}
		let units = [];

		const animusConfig = {
			userName: "Animus",
            resourceName: "animus",
			btnLabel: "Spawn Animus",
			addPerClick: {"animus": 1}
        }
		units.push(new Unit(animusConfig, true));

		const meatFarmConfig = {
			userName: "Meat Farm",
            resourceName: "meatfarm",
			clickCost: {"animus": 10},
			addPerClick: {"meatfarm": 1},
			addPerSecond: {"felhog": 0.1},
		}
		units.push(new Unit(meatFarmConfig, true));

		const FelhogConfig = {
			userName: "Felhog",
			resourceName: "felhog",
			addPerSecond: {"animus": 1},
			unlockCondition: { resources: { "felhog": 1 }}
		}
		units.push(new Unit(FelhogConfig, false));

		const FiendConfig = {
			userName: "Fiend",
			resourceName: "fiend",
			clickCost: {"felhog": 1},
			addPerClick: {"fiend": 1},
            unlockCondition: { resources: { "meatfarm": 10 }}
		}
		units.push(new Unit(FiendConfig, false));
		gUpdate();


		function addDiv(parent, _class){
			let div = document.createElement("div");
			parent.appendChild(div);
			if(_class) div.classList.add(_class);
			return div;
		}
		function addSpan(parent, _class){
			let span = document.createElement("span");
			parent.appendChild(span);
			if(_class) span.classList.add(_class);
			return span;
        }
		function addBtn(parent, onClick){
			let btn = document.createElement('button');
			parent.appendChild(btn);
			btn.addEventListener('click', onClick);
			return btn;
		}

		setInterval(() => {
			gProduce();
			gUpdate();
		}, 1000);

        //setInterval(() => {
        //    animus += drones; // Each drone produces 1 animus per second
        //    updateUI();
        //}, 1000);
    </script>
</body>
</html>
